<!--
  -  Grouping of TA0002 "Execution" rules
  -  Author: Fabricio Brunetti
  -  Updated by Wazuh, Inc.
  -  Copyright (C) 2015-2021, Wazuh Inc.
  -  This program is a free software; you can redistribute it and/or modify it under the terms of GPLv2.
-->




<group name="TA0002,">

    <!-- Sample: {"win":{"system":{"providerName":"Microsoft-Windows-Sysmon","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","eventID":"11","version":"2","level":"4","task":"11","opcode":"0","keywords":"0x8000000000000000","systemTime":"2021-04-28T20:11:55.0310966Z","eventRecordID":"144500","processID":"2204","threadID":"3300","channel":"Microsoft-Windows-Sysmon/Operational","computer":"DESKTOP-2QKFOBA","severityValue":"INFORMATION","message":"\"File created:\r\nRuleName: -\r\nUtcTime: 2021-04-28 20:11:55.021\r\nProcessGuid: {4dc16835-c189-6089-a003-000000002e00}\r\nProcessId: 6876\r\nImage: C:\\Windows\\system32\\cscript.exe\r\nTargetFilename: C:\\Users\\AtomicRedTeamTest\\AppData\\Roaming\\TransbaseOdbcDriver\\starter.vbs\r\nCreationUtcTime: 2021-04-28 20:11:55.021\""},"eventdata":{"utcTime":"2021-04-28 20:11:55.021","processGuid":"{4dc16835-c189-6089-a003-000000002e00}","processId":"6876","image":"C:\\\\Windows\\\\system32\\\\cscript.exe","targetFilename":"C:\\\\Users\\\\AtomicRedTeamTest\\\\AppData\\\\Roaming\\\\TransbaseOdbcDriver\\\\starter.vbs","creationUtcTime":"2021-04-28 20:11:55.021"}}} -->
    <rule id="92000" level="4">
        <if_group>sysmon_event_11</if_group>
        <field name="win.eventdata.image" type="pcre2">\\(c|w)script\.exe</field>
        <field name="win.eventdata.targetFilename" type="pcre2">[c-z]:\\(Windows\\Temp)|Users\\.+\.(bat|cmd|lnk|pif|vbs|vbe|js|wsh|ps1)</field>
        <description>Script created a new scripting file under System or User data folder</description>
        <mitre>
            <id>T1059</id>
        </mitre>
    </rule>

    <!-- Sample: {"win":{"system":{"providerName":"Microsoft-Windows-Sysmon","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","eventID":"1","version":"5","level":"4","task":"1","opcode":"0","keywords":"0x8000000000000000","systemTime":"2021-04-28T20:11:55.3643213Z","eventRecordID":"144504","processID":"2204","threadID":"3300","channel":"Microsoft-Windows-Sysmon/Operational","computer":"DESKTOP-2QKFOBA","severityValue":"INFORMATION","message":"\"Process Create:\r\nRuleName: technique_id=T1202,technique_name=Indirect Command Execution\r\nUtcTime: 2021-04-28 20:11:55.352\r\nProcessGuid: {4dc16835-c18b-6089-a203-000000002e00}\r\nProcessId: 648\r\nImage: C:\\Windows\\System32\\wscript.exe\r\nFileVersion: 5.812.10240.16384\r\nDescription: Microsoft ® Windows Based Script Host\r\nProduct: Microsoft ® Windows Script Host\r\nCompany: Microsoft Corporation\r\nOriginalFileName: wscript.exe\r\nCommandLine: \"C:\\Windows\\System32\\WScript.exe\" \"C:\\Users\\AtomicRedTeamTest\\AppData\\Roaming\\TransbaseOdbcDriver\\starter.vbs\" \r\nCurrentDirectory: C:\\Users\\AtomicRedTeamTest\\Downloads\\\r\nUser: DESKTOP-2QKFOBA\\AtomicRedTeamTest\r\nLogonGuid: {4dc16835-596f-6089-d6a0-040000000000}\r\nLogonId: 0x4A0D6\r\nTerminalSessionId: 1\r\nIntegrityLevel: High\r\nHashes: SHA1=545EC11DEE642DE633EB2C6F6FFC90CCE4DECF8D,MD5=0639B0A6F69B3265C1E42227D650B7D1,SHA256=CE9F70E104C07D92FC05FBD6000839FD6A87FF010E706396F87DD679244ED97B,IMPHASH=0F71D5F6F4CBB935CE1B09754102419C\r\nParentProcessGuid: {4dc16835-c189-6089-a003-000000002e00}\r\nParentProcessId: 6876\r\nParentImage: C:\\Windows\\System32\\cscript.exe\r\nParentCommandLine: \"C:\\Windows\\system32\\cscript.exe\" .\\drop-payloads.vbe\""},"eventdata":{"ruleName":"technique_id=T1202,technique_name=Indirect Command Execution","utcTime":"2021-04-28 20:11:55.352","processGuid":"{4dc16835-c18b-6089-a203-000000002e00}","processId":"648","image":"C:\\\\Windows\\\\System32\\\\wscript.exe","fileVersion":"5.812.10240.16384","description":"Microsoft ® Windows Based Script Host","product":"Microsoft ® Windows Script Host","company":"Microsoft Corporation","originalFileName":"wscript.exe","commandLine":"\\\"C:\\\\Windows\\\\System32\\\\WScript.exe\\\" \\\"C:\\\\Users\\\\AtomicRedTeamTest\\\\AppData\\\\Roaming\\\\TransbaseOdbcDriver\\\\starter.vbs\\\"","currentDirectory":"C:\\\\Users\\\\AtomicRedTeamTest\\\\Downloads\\\\","user":"DESKTOP-2QKFOBA\\\\AtomicRedTeamTest","logonGuid":"{4dc16835-596f-6089-d6a0-040000000000}","logonId":"0x4a0d6","terminalSessionId":"1","integrityLevel":"High","hashes":"SHA1=545EC11DEE642DE633EB2C6F6FFC90CCE4DECF8D,MD5=0639B0A6F69B3265C1E42227D650B7D1,SHA256=CE9F70E104C07D92FC05FBD6000839FD6A87FF010E706396F87DD679244ED97B,IMPHASH=0F71D5F6F4CBB935CE1B09754102419C","parentProcessGuid":"{4dc16835-c189-6089-a003-000000002e00}","parentProcessId":"6876","parentImage":"C:\\\\Windows\\\\System32\\\\cscript.exe","parentCommandLine":"\\\"C:\\\\Windows\\\\system32\\\\cscript.exe\\\" .\\\\drop-payloads.vbe"}}} -->
    <rule id="92010" level="4">
        <if_group>sysmon_event1</if_group>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)\\(c|w)script\.exe.+\.(bat|cmd|lnk|pif|vbs|vbe|js|wsh|ps1)</field>
        <field name="win.eventdata.parentImage" type="pcre2">(?i)\\(c|w)script\.exe</field>
        <description>Scripting interpreter spawned new scripting interpreter</description>
        <mitre>
            <id>T1059</id>
        </mitre>
    </rule>

    <!-- Sample: {"win":{"system":{"providerName":"Microsoft-Windows-Sysmon","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","eventID":"1","version":"5","level":"4","task":"1","opcode":"0","keywords":"0x8000000000000000","systemTime":"2021-04-28T20:11:55.5366909Z","eventRecordID":"144512","processID":"2204","threadID":"3300","channel":"Microsoft-Windows-Sysmon/Operational","computer":"DESKTOP-2QKFOBA","severityValue":"INFORMATION","message":"\"Process Create:\r\nRuleName: technique_id=T1059.003,technique_name=Windows Command Shell\r\nUtcTime: 2021-04-28 20:11:55.529\r\nProcessGuid: {4dc16835-c18b-6089-a303-000000002e00}\r\nProcessId: 5256\r\nImage: C:\\Windows\\System32\\cmd.exe\r\nFileVersion: 10.0.19041.746 (WinBuild.160101.0800)\r\nDescription: Windows Command Processor\r\nProduct: Microsoft® Windows® Operating System\r\nCompany: Microsoft Corporation\r\nOriginalFileName: Cmd.Exe\r\nCommandLine: \"C:\\Windows\\System32\\cmd.exe\" /k wscript.exe \"C:\\Users\\AtomicRedTeamTest\\AppData\\Roaming\\\\TransBaseOdbcDriver\\\\TransBaseOdbcDriver.js\"\r\nCurrentDirectory: C:\\Users\\AtomicRedTeamTest\\Downloads\\\r\nUser: DESKTOP-2QKFOBA\\AtomicRedTeamTest\r\nLogonGuid: {4dc16835-596f-6089-d6a0-040000000000}\r\nLogonId: 0x4A0D6\r\nTerminalSessionId: 1\r\nIntegrityLevel: High\r\nHashes: SHA1=F1EFB0FDDC156E4C61C5F78A54700E4E7984D55D,MD5=8A2122E8162DBEF04694B9C3E0B6CDEE,SHA256=B99D61D874728EDC0918CA0EB10EAB93D381E7367E377406E65963366C874450,IMPHASH=272245E2988E1E430500B852C4FB5E18\r\nParentProcessGuid: {4dc16835-c18b-6089-a203-000000002e00}\r\nParentProcessId: 648\r\nParentImage: C:\\Windows\\System32\\wscript.exe\r\nParentCommandLine: \"C:\\Windows\\System32\\WScript.exe\" \"C:\\Users\\AtomicRedTeamTest\\AppData\\Roaming\\TransbaseOdbcDriver\\starter.vbs\" \""},"eventdata":{"ruleName":"technique_id=T1059.003,technique_name=Windows Command Shell","utcTime":"2021-04-28 20:11:55.529","processGuid":"{4dc16835-c18b-6089-a303-000000002e00}","processId":"5256","image":"C:\\\\Windows\\\\System32\\\\cmd.exe","fileVersion":"10.0.19041.746 (WinBuild.160101.0800)","description":"Windows Command Processor","product":"Microsoft® Windows® Operating System","company":"Microsoft Corporation","originalFileName":"Cmd.Exe","commandLine":"\\\"C:\\\\Windows\\\\System32\\\\cmd.exe\\\" /k wscript.exe \\\"C:\\\\Users\\\\AtomicRedTeamTest\\\\AppData\\\\Roaming\\\\\\\\TransBaseOdbcDriver\\\\\\\\TransBaseOdbcDriver.js\\\"","currentDirectory":"C:\\\\Users\\\\AtomicRedTeamTest\\\\Downloads\\\\","user":"DESKTOP-2QKFOBA\\\\AtomicRedTeamTest","logonGuid":"{4dc16835-596f-6089-d6a0-040000000000}","logonId":"0x4a0d6","terminalSessionId":"1","integrityLevel":"High","hashes":"SHA1=F1EFB0FDDC156E4C61C5F78A54700E4E7984D55D,MD5=8A2122E8162DBEF04694B9C3E0B6CDEE,SHA256=B99D61D874728EDC0918CA0EB10EAB93D381E7367E377406E65963366C874450,IMPHASH=272245E2988E1E430500B852C4FB5E18","parentProcessGuid":"{4dc16835-c18b-6089-a203-000000002e00}","parentProcessId":"648","parentImage":"C:\\\\Windows\\\\System32\\\\wscript.exe","parentCommandLine":"\\\"C:\\\\Windows\\\\System32\\\\WScript.exe\\\" \\\"C:\\\\Users\\\\AtomicRedTeamTest\\\\AppData\\\\Roaming\\\\TransbaseOdbcDriver\\\\starter.vbs\\\""}}} -->
    <rule id="92020" level="4">
        <if_group>sysmon_event1</if_group>
        <field name="win.eventdata.commandLine" type="pcre2">\\cmd\.exe</field>
        <field name="win.eventdata.parentImage" type="pcre2">(?i)\\(c|w)script\.exe</field>
        <description>Scripting interpreter spawned Windows command shell instance</description>
        <mitre>
            <id>T1059.003</id>
        </mitre>
    </rule>

    <!-- Sample: {"win":{"eventdata":{"originalFileName":"Cmd.Exe","image":"C:\\\\Windows\\\\System32\\\\cmd.exe","product":"Microsoft® Windows® Operating System","parentProcessGuid":"{4dc16835-3136-609c-2c01-000000003b00}","description":"Windows Command Processor","logonGuid":"{4dc16835-2e5f-609c-19a4-7c0000000000}","parentCommandLine":"powershell  -ExecutionPolicy Bypass -NoExit .\\\\meta.ps1","processGuid":"{4dc16835-3bdd-609c-5901-000000003b00}","logonId":"0x7ca419","parentProcessId":"1488","processId":"5560","currentDirectory":"C:\\\\Users\\\\AtomicRed\\\\Downloads\\\\","utcTime":"2021-05-12 20:34:37.091","hashes":"SHA1=F1EFB0FDDC156E4C61C5F78A54700E4E7984D55D,MD5=8A2122E8162DBEF04694B9C3E0B6CDEE,SHA256=B99D61D874728EDC0918CA0EB10EAB93D381E7367E377406E65963366C874450,IMPHASH=272245E2988E1E430500B852C4FB5E18","parentImage":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe","ruleName":"technique_id=T1059.003,technique_name=Windows Command Shell","company":"Microsoft Corporation","commandLine":"C:\\\\Windows\\\\system32\\\\cmd.exe","integrityLevel":"Medium","fileVersion":"10.0.19041.746 (WinBuild.160101.0800)","user":"EXCHANGETEST\\\\AtomicRed","terminalSessionId":"1"},"system":{"eventID":"1","keywords":"0x8000000000000000","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"Process Create:\r\nRuleName: technique_id=T1059.003,technique_name=Windows Command Shell\r\nUtcTime: 2021-05-12 20:34:37.091\r\nProcessGuid: {4dc16835-3bdd-609c-5901-000000003b00}\r\nProcessId: 5560\r\nImage: C:\\Windows\\System32\\cmd.exe\r\nFileVersion: 10.0.19041.746 (WinBuild.160101.0800)\r\nDescription: Windows Command Processor\r\nProduct: Microsoft® Windows® Operating System\r\nCompany: Microsoft Corporation\r\nOriginalFileName: Cmd.Exe\r\nCommandLine: C:\\Windows\\system32\\cmd.exe\r\nCurrentDirectory: C:\\Users\\AtomicRed\\Downloads\\\r\nUser: EXCHANGETEST\\AtomicRed\r\nLogonGuid: {4dc16835-2e5f-609c-19a4-7c0000000000}\r\nLogonId: 0x7CA419\r\nTerminalSessionId: 1\r\nIntegrityLevel: Medium\r\nHashes: SHA1=F1EFB0FDDC156E4C61C5F78A54700E4E7984D55D,MD5=8A2122E8162DBEF04694B9C3E0B6CDEE,SHA256=B99D61D874728EDC0918CA0EB10EAB93D381E7367E377406E65963366C874450,IMPHASH=272245E2988E1E430500B852C4FB5E18\r\nParentProcessGuid: {4dc16835-3136-609c-2c01-000000003b00}\r\nParentProcessId: 1488\r\nParentImage: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\r\nParentCommandLine: powershell  -ExecutionPolicy Bypass -NoExit .\\meta.ps1\"","version":"5","systemTime":"2021-05-12T20:34:37.0992054Z","eventRecordID":"199321","threadID":"3320","computer":"hrmanager.ExchangeTest.com","task":"1","processID":"2080","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}} -->
    <rule id="92021" level="4">
        <if_group>sysmon_event1</if_group>
        <field name="win.eventdata.commandLine" type="pcre2">\\cmd\.exe</field>
        <field name="win.eventdata.parentImage" type="pcre2">(?i)\\powershell\.exe</field>
        <description>Powershell process spawned Windows command shell instance</description>
        <mitre>
            <id>T1059.003</id>
        </mitre>
    </rule>

    <!-- Sample: {"win":{"system":{"providerName":"Microsoft-Windows-Sysmon","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","eventID":"1","version":"5","level":"4","task":"1","opcode":"0","keywords":"0x8000000000000000","systemTime":"2021-04-28T20:11:55.6337382Z","eventRecordID":"144514","processID":"2204","threadID":"3300","channel":"Microsoft-Windows-Sysmon/Operational","computer":"DESKTOP-2QKFOBA","severityValue":"INFORMATION","message":"\"Process Create:\r\nRuleName: technique_id=T1202,technique_name=Indirect Command Execution\r\nUtcTime: 2021-04-28 20:11:55.619\r\nProcessGuid: {4dc16835-c18b-6089-a503-000000002e00}\r\nProcessId: 2488\r\nImage: C:\\Windows\\System32\\wscript.exe\r\nFileVersion: 5.812.10240.16384\r\nDescription: Microsoft ® Windows Based Script Host\r\nProduct: Microsoft ® Windows Script Host\r\nCompany: Microsoft Corporation\r\nOriginalFileName: wscript.exe\r\nCommandLine: wscript.exe  \"C:\\Users\\AtomicRedTeamTest\\AppData\\Roaming\\\\TransBaseOdbcDriver\\\\TransBaseOdbcDriver.js\"\r\nCurrentDirectory: C:\\Users\\AtomicRedTeamTest\\Downloads\\\r\nUser: DESKTOP-2QKFOBA\\AtomicRedTeamTest\r\nLogonGuid: {4dc16835-596f-6089-d6a0-040000000000}\r\nLogonId: 0x4A0D6\r\nTerminalSessionId: 1\r\nIntegrityLevel: High\r\nHashes: SHA1=545EC11DEE642DE633EB2C6F6FFC90CCE4DECF8D,MD5=0639B0A6F69B3265C1E42227D650B7D1,SHA256=CE9F70E104C07D92FC05FBD6000839FD6A87FF010E706396F87DD679244ED97B,IMPHASH=0F71D5F6F4CBB935CE1B09754102419C\r\nParentProcessGuid: {4dc16835-c18b-6089-a303-000000002e00}\r\nParentProcessId: 5256\r\nParentImage: C:\\Windows\\System32\\cmd.exe\r\nParentCommandLine: \"C:\\Windows\\System32\\cmd.exe\" /k wscript.exe \"C:\\Users\\AtomicRedTeamTest\\AppData\\Roaming\\\\TransBaseOdbcDriver\\\\TransBaseOdbcDriver.js\"\""},"eventdata":{"ruleName":"technique_id=T1202,technique_name=Indirect Command Execution","utcTime":"2021-04-28 20:11:55.619","processGuid":"{4dc16835-c18b-6089-a503-000000002e00}","processId":"2488","image":"C:\\\\Windows\\\\System32\\\\wscript.exe","fileVersion":"5.812.10240.16384","description":"Microsoft ® Windows Based Script Host","product":"Microsoft ® Windows Script Host","company":"Microsoft Corporation","originalFileName":"wscript.exe","commandLine":"wscript.exe  \\\"C:\\\\Users\\\\AtomicRedTeamTest\\\\AppData\\\\Roaming\\\\\\\\TransBaseOdbcDriver\\\\\\\\TransBaseOdbcDriver.js\\\"","currentDirectory":"C:\\\\Users\\\\AtomicRedTeamTest\\\\Downloads\\\\","user":"DESKTOP-2QKFOBA\\\\AtomicRedTeamTest","logonGuid":"{4dc16835-596f-6089-d6a0-040000000000}","logonId":"0x4a0d6","terminalSessionId":"1","integrityLevel":"High","hashes":"SHA1=545EC11DEE642DE633EB2C6F6FFC90CCE4DECF8D,MD5=0639B0A6F69B3265C1E42227D650B7D1,SHA256=CE9F70E104C07D92FC05FBD6000839FD6A87FF010E706396F87DD679244ED97B,IMPHASH=0F71D5F6F4CBB935CE1B09754102419C","parentProcessGuid":"{4dc16835-c18b-6089-a303-000000002e00}","parentProcessId":"5256","parentImage":"C:\\\\Windows\\\\System32\\\\cmd.exe","parentCommandLine":"\\\"C:\\\\Windows\\\\System32\\\\cmd.exe\\\" /k wscript.exe \\\"C:\\\\Users\\\\AtomicRedTeamTest\\\\AppData\\\\Roaming\\\\\\\\TransBaseOdbcDriver\\\\\\\\TransBaseOdbcDriver.js\\\""}}}-->
    <rule id="92030" level="4">
        <if_group>sysmon_event1</if_group>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)\\(c|w)script\.exe.+[c-z]:\\(Windows\\Temp)|Users\\.+\.(bat|cmd|lnk|pif|vbs|vbe|js|wsh|ps1)</field>
        <field name="win.eventdata.parentCommandLine" type="pcre2">(?i)cmd\.exe.+/(c|k)</field>
        <description>Command shell started script with /c modifier</description>
        <mitre>
            <id>T1059</id>
        </mitre>
    </rule>


</group>
