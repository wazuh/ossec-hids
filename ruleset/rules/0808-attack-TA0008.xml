<!--
  -  Grouping of TA0008 "Discovery" rules
  -  Author: Fabricio Brunetti
  -  Updated by Wazuh, Inc.
  -  Copyright (C) 2015-2021, Wazuh Inc.
  -  This program is a free software; you can redistribute it and/or modify it under the terms of GPLv2.
-->




<group name="TA0008,">
    <!-- Sample: {"win":{"eventdata":{"originalFileName":"PSCP","image":"C:\\\\Users\\\\AtomicRed\\\\AppData\\\\Roaming\\\\TransbaseOdbcDriver\\\\pscp.exe","product":"PuTTY suite","parentProcessGuid":"{4dc16835-3bdd-609c-5901-000000003b00}","description":"Command-line SCP/SFTP client","logonGuid":"{4dc16835-2e5f-609c-19a4-7c0000000000}","parentCommandLine":"C:\\\\Windows\\\\system32\\\\cmd.exe","processGuid":"{4dc16835-416a-609c-7601-000000003b00}","logonId":"0x7ca419","parentProcessId":"5560","processId":"2180","currentDirectory":"C:\\\\Users\\\\AtomicRed\\\\AppData\\\\Roaming\\\\TransbaseOdbcDriver\\\\","utcTime":"2021-05-12 20:58:18.149","hashes":"SHA1=EE1B5F3A7F9563A9E7575EDDA467794584555F97,MD5=3145D4A197A3523253880E9E6E76F798,SHA256=7A09FD6885CA5662A40D6F9212C115D8F38C88F9C1BCDA697854BFB202F289B2,IMPHASH=C2612378E2F461D6FCF8743722ABEB7A","parentImage":"C:\\\\Windows\\\\System32\\\\cmd.exe","ruleName":"technique_id=T1059.003,technique_name=Windows Command Shell","company":"Simon Tatham","commandLine":"pscp.exe  -scp psexec.py administrator@Exchangetest.com@192.168.0.218:/tmp/psexec.py","integrityLevel":"Medium","fileVersion":"Release 0.73","user":"EXCHANGETEST\\\\AtomicRed","terminalSessionId":"1"},"system":{"eventID":"1","keywords":"0x8000000000000000","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"Process Create:\r\nRuleName: technique_id=T1059.003,technique_name=Windows Command Shell\r\nUtcTime: 2021-05-12 20:58:18.149\r\nProcessGuid: {4dc16835-416a-609c-7601-000000003b00}\r\nProcessId: 2180\r\nImage: C:\\Users\\AtomicRed\\AppData\\Roaming\\TransbaseOdbcDriver\\pscp.exe\r\nFileVersion: Release 0.73\r\nDescription: Command-line SCP/SFTP client\r\nProduct: PuTTY suite\r\nCompany: Simon Tatham\r\nOriginalFileName: PSCP\r\nCommandLine: pscp.exe  -scp psexec.py administrator@Exchangetest.com@192.168.0.218:/tmp/psexec.py\r\nCurrentDirectory: C:\\Users\\AtomicRed\\AppData\\Roaming\\TransbaseOdbcDriver\\\r\nUser: EXCHANGETEST\\AtomicRed\r\nLogonGuid: {4dc16835-2e5f-609c-19a4-7c0000000000}\r\nLogonId: 0x7CA419\r\nTerminalSessionId: 1\r\nIntegrityLevel: Medium\r\nHashes: SHA1=EE1B5F3A7F9563A9E7575EDDA467794584555F97,MD5=3145D4A197A3523253880E9E6E76F798,SHA256=7A09FD6885CA5662A40D6F9212C115D8F38C88F9C1BCDA697854BFB202F289B2,IMPHASH=C2612378E2F461D6FCF8743722ABEB7A\r\nParentProcessGuid: {4dc16835-3bdd-609c-5901-000000003b00}\r\nParentProcessId: 5560\r\nParentImage: C:\\Windows\\System32\\cmd.exe\r\nParentCommandLine: C:\\Windows\\system32\\cmd.exe\"","version":"5","systemTime":"2021-05-12T20:58:18.1529188Z","eventRecordID":"199658","threadID":"3320","computer":"hrmanager.ExchangeTest.com","task":"1","processID":"2080","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}} -->
    <rule id="92080" level="6">
        <if_group>sysmon_event1</if_group>
        <field name="win.eventdata.originalFileName" type="pcre2">PSCP</field>
        <field name="win.eventdata.parentCommandLine" type="pcre2">(?i)-scp</field>
        <description>A file was copied to other system over SSH using pscp.exe</description>
        <mitre>
            <id>T1021.004</id>
        </mitre>
    </rule>

    <!-- Sample: type=SYSCALL msg=audit(1620937405.872:764): arch=c000003e syscall=2 success=yes exit=4 a0=555c2e4a6fb0 a1=41 a2=1a4 a3=7fcfaf0607b8 items=2 ppid=7903 pid=7909 auid=1198400500 uid=1198400500 gid=1198400513 euid=1198400500 suid=1198400500 fsuid=1198400500 egid=1198400513 sgid=1198400513 fsgid=1198400513 tty=(none) ses=21 comm="scp" exe="/usr/bin/scp" subj=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 key="wazuh_fim" type=CWD msg=audit(1620937405.872:764):  cwd="/home/administrator@ExchangeTest.com" type=PATH msg=audit(1620937405.872:764): item=0 name="/tmp/" inode=8409157 dev=fd:00 mode=041777 ouid=0 ogid=0 rdev=00:00 obj=system_u:object_r:tmp_t:s0 objtype=PARENT cap_fp=0000000000000000 cap_fi=0000000000000000 cap_fe=0 cap_fver=0 type=PATH msg=audit(1620937405.872:764): item=1 name="/tmp/ps2.py" inode=9595745 dev=fd:00 mode=0100644 ouid=1198400500 ogid=1198400513 rdev=00:00 obj=unconfined_u:object_r:user_tmp_t:s0 objtype=CREATE cap_fp=0000000000000000 cap_fi=0000000000000000 cap_fe=0 cap_fver=0 type=PROCTITLE msg=audit(1620937405.872:764): proctitle=736370002D74002F746D702F7073322E7079 -->
    <rule id="92081" level="6">
        <if_group>audit</if_group>
        <field name="audit.command" type="pcre2">scp</field>
        <field name="audit.file.name" type="pcre2">.+</field>
        <description>A file was copied to this system over SSH using SCP</description>
        <mitre>
            <id>T1021.004</id>
        </mitre>
    </rule>
</group>